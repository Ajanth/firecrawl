name: Firestorm - Init VM

on:
  workflow_dispatch:

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - name: Bootstrap VM (Docker + Compose + Caddy)
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.SSH_HOSTNAME }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            export DEBIAN_FRONTEND=noninteractive

            echo "Checking sudo (non-interactive)..."
            sudo -n true

            echo "Updating apt..."
            sudo apt-get update -y

            echo "Installing base packages..."
            sudo apt-get install -y ca-certificates curl gnupg git

            echo "Installing Docker + Compose plugin (if missing)..."
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get install -y docker.io
              sudo systemctl enable docker
              sudo systemctl start docker
            fi

            # Ensure Compose v2 is available as `docker compose`. Ubuntu's repo doesn't always ship
            # `docker-compose-plugin`, so fall back to installing the official plugin binary.
            if ! sudo docker compose version >/dev/null 2>&1; then
              echo "Installing docker compose plugin..."
              if sudo apt-get install -y docker-compose-plugin; then
                true
              else
                echo "Apt package docker-compose-plugin not available; installing plugin binary..."
                arch="$(uname -m)"
                case "$arch" in
                  x86_64|amd64) bin="docker-compose-linux-x86_64" ;;
                  aarch64|arm64) bin="docker-compose-linux-aarch64" ;;
                  *)
                    echo "Unsupported architecture for docker compose plugin: $arch"
                    exit 1
                    ;;
                esac
                ver="$(curl -fsSL https://api.github.com/repos/docker/compose/releases/latest | sed -n 's/.*\"tag_name\": \"\\(v[^\"]*\\)\".*/\\1/p' | head -n 1)"
                if [ -z "$ver" ]; then
                  echo "Failed to resolve latest docker/compose version"
                  exit 1
                fi
                url="https://github.com/docker/compose/releases/download/${ver}/${bin}"
                sudo mkdir -p /usr/local/lib/docker/cli-plugins
                sudo curl -fsSL "$url" -o /usr/local/lib/docker/cli-plugins/docker-compose
                sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              fi
            fi

            echo "Verifying Docker..."
            sudo docker info >/dev/null
            sudo docker compose version >/dev/null

            echo "Installing Caddy (if missing)..."
            if ! command -v caddy >/dev/null 2>&1; then
              sudo apt-get install -y debian-keyring debian-archive-keyring apt-transport-https
              curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
              curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list >/dev/null
              sudo apt-get update -y
              sudo apt-get install -y caddy
            fi

            echo "Enabling + starting Caddy..."
            sudo systemctl enable caddy
            sudo systemctl start caddy

            echo "Versions:"
            docker --version || true
            sudo docker compose version || true
            caddy version || true

            echo "Services:"
            sudo systemctl is-active --quiet docker
            sudo systemctl is-active --quiet caddy

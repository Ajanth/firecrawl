name: Firestorm - Init VM

on:
  workflow_dispatch:

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - name: Bootstrap VM (Docker + Compose + Caddy)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOSTNAME }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            export DEBIAN_FRONTEND=noninteractive

            echo "Checking sudo (non-interactive)..."
            sudo -n true

            echo "Updating apt..."
            sudo apt-get update -y

            echo "Installing base packages..."
            sudo apt-get install -y ca-certificates curl gnupg git

            echo "Installing Docker + Compose plugin (if missing)..."
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get install -y docker.io docker-compose-plugin
              sudo systemctl enable docker
              sudo systemctl start docker
            else
              sudo apt-get install -y docker-compose-plugin || true
              sudo systemctl enable docker || true
              sudo systemctl start docker || true
            fi

            echo "Verifying Docker..."
            sudo docker info >/dev/null

            echo "Installing Caddy (if missing)..."
            if ! command -v caddy >/dev/null 2>&1; then
              sudo apt-get install -y debian-keyring debian-archive-keyring apt-transport-https
              curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
              curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list >/dev/null
              sudo apt-get update -y
              sudo apt-get install -y caddy
            fi

            echo "Enabling + starting Caddy..."
            sudo systemctl enable caddy
            sudo systemctl start caddy

            echo "Versions:"
            docker --version || true
            sudo docker compose version || true
            caddy version || true

            echo "Services:"
            sudo systemctl is-active --quiet docker
            sudo systemctl is-active --quiet caddy


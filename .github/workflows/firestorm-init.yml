name: Firestorm - Init VM

on:
  workflow_dispatch:

jobs:
  init:
    runs-on: ubuntu-latest
    steps:
      - name: Bootstrap VM (Docker + Compose + Caddy)
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.SSH_HOSTNAME }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            export DEBIAN_FRONTEND=noninteractive

            echo "Checking sudo (non-interactive)..."
            sudo -n true

            echo "Updating apt..."
            sudo apt-get update -y

            echo "Installing base packages..."
            sudo apt-get install -y ca-certificates curl gnupg git

            echo "Installing Docker + Compose plugin (if missing)..."
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get install -y docker.io
              sudo systemctl enable docker
              sudo systemctl start docker
            fi

            # Ensure Compose v2 is available as `docker compose`.
            # On Ubuntu 24.04, the most reliable path is installing `docker-compose-v2`.
            # Only if that fails do we add Docker's official apt repo to get `docker-compose-plugin`.
            if ! sudo docker compose version >/dev/null 2>&1; then
              echo "Installing docker compose (Ubuntu package: docker-compose-v2)..."
              sudo apt-get install -y docker-compose-v2 || true
            fi

            if ! sudo docker compose version >/dev/null 2>&1; then
              echo "Ubuntu package did not provide docker compose; adding Docker apt repo for compose plugin..."
              sudo install -m 0755 -d /etc/apt/keyrings
              sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
              sudo chmod a+r /etc/apt/keyrings/docker.asc

              . /etc/os-release
              arch="$(dpkg --print-architecture)"

              echo "deb [arch=${arch} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu ${VERSION_CODENAME} stable" | sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
              sudo apt-get update -y

              # Install just the compose plugin if possible; avoid re-installing docker engine here.
              sudo apt-get install -y docker-compose-plugin || true
            fi

            if ! sudo docker compose version >/dev/null 2>&1; then
              echo "Failed to install docker compose. Expected either `docker-compose-v2` or `docker-compose-plugin` to provide it."
              exit 1
            fi

            echo "Verifying Docker..."
            sudo docker info >/dev/null
            sudo docker compose version >/dev/null

            echo "Installing Caddy (if missing)..."
            if ! command -v caddy >/dev/null 2>&1; then
              sudo apt-get install -y debian-keyring debian-archive-keyring apt-transport-https
              curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
              curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list >/dev/null
              sudo apt-get update -y
              sudo apt-get install -y caddy
            fi

            echo "Enabling + starting Caddy..."
            sudo systemctl enable caddy
            sudo systemctl start caddy

            echo "Versions:"
            docker --version || true
            sudo docker compose version || true
            caddy version || true

            echo "Services:"
            sudo systemctl is-active --quiet docker
            sudo systemctl is-active --quiet caddy

name: Firestorm - Deploy

on:
  workflow_dispatch:

concurrency:
  group: firestorm-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Render env file for VM
        shell: bash
        run: |
          set -euo pipefail
          escape_dotenv() {
            # Quote values so spaces/# don't break parsing. Newlines aren't supported by dotenv anyway.
            printf '%s' "${1:-}" | sed -e 's|\\|\\\\|g' -e 's|"|\\"|g'
          }

          {
            echo "# Required"
            echo "HOST=0.0.0.0"
            echo "INTERNAL_PORT=3002"
            echo
            echo "# Optional (blank is OK)"
            printf 'OPENAI_API_KEY="%s"\n' "$(escape_dotenv "${OPENAI_API_KEY:-}")"
            printf 'BULL_AUTH_KEY="%s"\n' "$(escape_dotenv "${BULL_AUTH_KEY:-}")"
            printf 'POSTGRES_USER="%s"\n' "$(escape_dotenv "${POSTGRES_USER:-}")"
            printf 'POSTGRES_PASSWORD="%s"\n' "$(escape_dotenv "${POSTGRES_PASSWORD:-}")"
            printf 'POSTGRES_DB="%s"\n' "$(escape_dotenv "${POSTGRES_DB:-}")"
            printf 'PROXY_SERVER="%s"\n' "$(escape_dotenv "${PROXY_SERVER:-}")"
            printf 'PROXY_USERNAME="%s"\n' "$(escape_dotenv "${PROXY_USERNAME:-}")"
            printf 'PROXY_PASSWORD="%s"\n' "$(escape_dotenv "${PROXY_PASSWORD:-}")"
          } > firestorm.env
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BULL_AUTH_KEY: ${{ secrets.BULL_AUTH_KEY }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}
          PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
          PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}

      - name: Copy env file to VM
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOSTNAME }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: firestorm.env
          target: /tmp/

      - name: Deploy Firecrawl + configure Caddy (remote)
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.SSH_HOSTNAME }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            if ! sudo -n true; then
              echo "sudo requires a password. Fix sudo on the VM, then re-run."
              exit 1
            fi

            if ! command -v docker >/dev/null 2>&1; then
              echo "Docker not installed on VM. Run workflow: Firestorm - Init VM"
              exit 1
            fi
            if ! sudo docker compose version >/dev/null 2>&1; then
              echo "Docker Compose plugin not installed on VM. Run workflow: Firestorm - Init VM"
              exit 1
            fi
            if ! command -v git >/dev/null 2>&1; then
              echo "git not installed on VM. Run workflow: Firestorm - Init VM"
              exit 1
            fi
            if ! command -v caddy >/dev/null 2>&1; then
              echo "Caddy not installed on VM. Run workflow: Firestorm - Init VM"
              exit 1
            fi

            DEPLOY_DIR=/opt/firecrawl
            REPO_URL=https://github.com/Ajanth/firecrawl.git
            BRANCH='${{ vars.FIRECRAWL_BRANCH }}'
            DOMAIN='${{ vars.FIRECRAWL_DOMAIN }}'
            HOST_PORT='${{ vars.FIRECRAWL_PORT }}'

            sudo mkdir -p "$DEPLOY_DIR"
            sudo chown "$USER:$USER" "$DEPLOY_DIR"

            if [ ! -d "$DEPLOY_DIR/.git" ]; then
              rm -rf "$DEPLOY_DIR"/*
              git clone --branch "$BRANCH" --recursive "$REPO_URL" "$DEPLOY_DIR"
            fi

            cd "$DEPLOY_DIR"
            git fetch origin
            git checkout "$BRANCH"
            git pull --ff-only origin "$BRANCH"
            git submodule update --init --recursive

            mv /tmp/firestorm.env "$DEPLOY_DIR/.env"

            cat > "$DEPLOY_DIR/docker-compose.firestorm.override.yaml" <<EOF
            services:
              api:
                ports:
                  - "127.0.0.1:${HOST_PORT}:3002"
            EOF

            # Idempotency + port safety:
            # - Bring the previous stack down (keeps named volumes unless -v is used).
            # - Ensure the host port is free before starting, otherwise Docker will fail with "address already in use".
            echo "Stopping previous firestorm stack (keeps volumes)..."
            sudo docker compose --project-name firestorm \
              -f docker-compose.yaml \
              -f docker-compose.override.yaml \
              -f docker-compose.firestorm.override.yaml \
              --env-file .env \
              down --remove-orphans || true

            echo "Ensuring 127.0.0.1:${HOST_PORT} is free..."
            if ! command -v ss >/dev/null 2>&1; then
              echo "Missing ss(8); install iproute2 and re-run init."
              exit 1
            fi
            if ! command -v fuser >/dev/null 2>&1; then
              export DEBIAN_FRONTEND=noninteractive
              sudo apt-get update -y
              sudo apt-get install -y psmisc
            fi

            # Stop any other container holding the port (from any other project).
            mapfile -t port_containers < <(sudo docker ps --filter "publish=${HOST_PORT}" --format '{{.ID}}' || true)
            for cid in "${port_containers[@]}"; do
              [ -n "${cid:-}" ] || continue
              echo "Stopping container using port ${HOST_PORT}: $cid"
              sudo docker stop "$cid" || true
              sudo docker rm "$cid" || true
            done

            # Use -H to avoid matching ss headers (false positives).
            if sudo ss -H -ltnp "sport = :${HOST_PORT}" 2>/dev/null | grep -q .; then
              echo "Port ${HOST_PORT} still in use after container cleanup; attempting to kill listener..."
              sudo ss -H -ltnp "sport = :${HOST_PORT}" || true
              sudo fuser -k "${HOST_PORT}/tcp" || true
              sleep 2
            fi

            if sudo ss -H -ltnp "sport = :${HOST_PORT}" 2>/dev/null | grep -q .; then
              echo "Port ${HOST_PORT} still in use; details:"
              sudo ss -H -ltnp "sport = :${HOST_PORT}" || true

              # If a stale docker-proxy is holding the port, restarting Docker clears it.
              if sudo ss -H -ltnp "sport = :${HOST_PORT}" 2>/dev/null | grep -q 'docker-proxy'; then
                echo "Detected docker-proxy holding port ${HOST_PORT}; restarting Docker..."
                sudo systemctl restart docker
                sleep 3
              fi
            fi

            if sudo ss -H -ltnp "sport = :${HOST_PORT}" 2>/dev/null | grep -q .; then
              echo "Port ${HOST_PORT} is still in use after cleanup; refusing to continue."
              sudo docker ps --format '{{.Names}} {{.Ports}}' | grep -E "(:|0\\.0\\.0\\.0:|127\\.0\\.0\\.1:)${HOST_PORT}->" || true
              sudo ss -H -ltnp "sport = :${HOST_PORT}" || true
              exit 1
            fi

            sudo docker compose --project-name firestorm \
              -f docker-compose.yaml \
              -f docker-compose.override.yaml \
              -f docker-compose.firestorm.override.yaml \
              --env-file .env \
              up -d --build --remove-orphans

            echo "Local health check (http://127.0.0.1:${HOST_PORT}/v0/health/readiness)..."
            i=0
            while [ "$i" -lt 30 ]; do
              if curl -fsS "http://127.0.0.1:${HOST_PORT}/v0/health/readiness" >/dev/null 2>&1; then
                break
              fi
              i=$((i+1))
              sleep 3
            done
            if [ "$i" -ge 30 ]; then
              echo "Local API health check failed"
              sudo docker compose --project-name firestorm \
                -f docker-compose.yaml -f docker-compose.override.yaml -f docker-compose.firestorm.override.yaml \
                --env-file .env ps || true
              sudo docker compose --project-name firestorm \
                -f docker-compose.yaml -f docker-compose.override.yaml -f docker-compose.firestorm.override.yaml \
                --env-file .env logs --no-color --tail=250 api || true
              exit 1
            fi

            echo "Writing Caddy config..."
            BASIC_USER='${{ secrets.BASIC_AUTH_USER }}'
            BASIC_PASS='${{ secrets.BASIC_AUTH_PASSWORD }}'
            HASH="$(caddy hash-password --plaintext "$BASIC_PASS")"
            sudo tee /etc/caddy/Caddyfile >/dev/null <<EOF
            ${DOMAIN} {
              encode zstd gzip
              basicauth {
                ${BASIC_USER} ${HASH}
              }
              reverse_proxy 127.0.0.1:${HOST_PORT}
            }
            EOF

            sudo caddy validate --config /etc/caddy/Caddyfile
            sudo systemctl reload caddy

      - name: External health checks (HTTPS + Basic Auth)
        shell: bash
        env:
          FIRECRAWL_DOMAIN: ${{ vars.FIRECRAWL_DOMAIN }}
          BASIC_AUTH_USER: ${{ secrets.BASIC_AUTH_USER }}
          BASIC_AUTH_PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}
        run: |
          set -euo pipefail

          url="https://${FIRECRAWL_DOMAIN}/v0/health/readiness"

          echo "Unauthenticated should be 401..."
          code="$(curl -sS -o /dev/null -w '%{http_code}' "$url" || true)"
          if [ "$code" != "401" ]; then
            echo "Expected 401, got $code"
            exit 1
          fi

          echo "Authenticated should be 200 (retrying for cert issuance + warmup)..."
          for i in {1..20}; do
            if curl -u "${BASIC_AUTH_USER}:${BASIC_AUTH_PASSWORD}" -fsS "$url" >/dev/null 2>&1; then
              exit 0
            fi
            sleep 3
          done

          echo "Authenticated check failed"
          curl -u "${BASIC_AUTH_USER}:${BASIC_AUTH_PASSWORD}" -sS -o /dev/null -w 'http_code=%{http_code}\n' "$url" || true
          exit 1
